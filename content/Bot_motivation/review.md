## Ревью на проект [Bot_motivation](https://github.com/Anikavuk/Bot_motivation)


## Плюсы

1. Хорошо разобралась как можно использовать внешние ресурсы для работы с генерацией текста

2. Классно, что бот умеет быть ласковым и суровым, понравилось.

3. Использование переменной `__all__` в python для испортов - это хорошо, делает импорты более предскажуемы, но размещать эту переменную принятно вверху файла.

4. Есть докстринги, это хорошая практика. Но минусы в этом тоже есть, будет написано ниже.

5. В классе SessionDependency - checking_session_id и get_session_id_or_error - отличная пара методов, хорошо дополняющих друг друга, один создает/гарантирует сессию, другой валидирует/требует существующую сессию

6. Класс PredictionService - четкое назначение, разделение методов, обработка ошибок, правильное использование UTC.
Но слабые стороны в этом классе тоже есть: смешение бизнес логики по выдаче предсказаний (взять из БД или сгенериовать новое), и работа с самой БД.
Хорошо бы их разнести, бизнес логика в этом классе, а работа с базой данных в другом месте.
А так вообще идея хорошая с использованием типа кеша в виде записи в БД, чтобы не грузить модель лишний раз.

7. Есть тесты, за их наличие ставлю плюс

8. Отдельный респект за докерфайл: multistage сборка - это прям хорошо. 
Правда комментарии в докерфайле излишни и запуск от root не допустим в проде, но на этом сейчас можно не заморачиваться


## Минусы или что можно улучшить

1. Работа с переменными в файле .env. Принятно имена констант писать в upper стиле, вместо "db_name" надо "DB_NAME" и так далее. В питон коде тоже, не только в env файле

```
db_name=NAME DB
db_user=USER NAME
db_password=PASSWORD DB
db_host=HOST DB
db_port=PORT DB
db_echo=TRUE
hf_token=ТОКЕН ОТ HuggingFace
bot_token= ТОКЕН ОТ ТЕЛЕГРАМ
admin_id=ID ADMIN
SESSION_SECRET=SESSION_SECRET
```

Также в документации принятно описывать что это за переменные в .env файле лежат, имя - описание, на каждую переменную.

Ну и ещё по возможности сократить их количество. В больших проектах бывает десятки таких переменных, которые потом теряются и никто не знает откуда она и где используется.
Например можно db_name + db_user + db_password + db_host + db_port объединить в одну с именем DATABASE_URL, вся строка будет там целиком.
Тогда метод db_url будет не нужен.

Ну и сам объект с энвами почему бы не получить как у тебя в закомментированной строчке сделано?
`settings = Settings()`
Вполне хороший вариант, часто применяемый. А то в функции get_settings всегда создается новый объект с теми же самыми значениями настроек. Это излишне.
Есть там танцы с бубном чтобы в этой функции проверять если ли объект, если нет, то создавать его один раз, а потом при последующих вызовах его просто возвращать.
Но зачем, если можно сделать проще как в твоем комменте ?

В этот env ещё можно добавить хост и порт самого приложения.
```
def run_app():
    uvicorn.run(
        web_app,
        host="127.0.0.1",
        port=8000,
        loop="asyncio",
        log_config=None,
        log_level="debug",
    )
```

Чтобы не писать тут host="127.0.0.1", и port=8000, а вынести их в env APP_HOST и APP_PORT, и в settings их.
К тому же у тебя в докер файле эти же переменные переопределяются, а если их иэ одного истончика брать, то и поменять надо будет в одном месте.
Ещё и в докер компоуз файле они же повторяются. Вообщем мастхев.

Если захочется поменять тип модели, как у тебя уже есть в коде `_MODEL_NAME`, то как раз можно ещё добавить эту строку в файлик env и оттуда его доставать.

В целом хорошая работа с переменными окружения.

2. Есть излишняя аннотация
```
def __init__(self, token_env_var: str = "HF_TOKEN") -> None:
    """
    Инициализация клиента Hugging Face.
    :param token_env_var: Имя переменной окружения с API токеном
    :type token_env_var: Str
    :return None
    """
```
Тут как будто не надо указывать в докстринге типы данных - `:type token_env_var: Str` это излишество, так ещё и с ошибкой в регистре если смотреть на тип данных

3. Есть неиспользуемые импорты в файле `/Bot_motivation/src/app/api/routes.py`

```
from datetime import datetime, timezone
from src.app.schemas.schemas import CreateUser
from src.app.services.motivation_service import HuggingFacePredictor
HTTPException
```

все они не используются в данном файле

4. Есть закомментированные строчки кода - удалить их или раскомментировать

типа таких
```
    # bot_manager.dispatcher.include_router(bot_manager.router)
```

таких

```     
# if self.mode == "dev":
#     self.base_preregistered_loggers.extend(["sqlalchemy", "alembic"])
```

или таких
```
#
# @asynccontextmanager
# async def dev_lifespan(app: FastAPI):
#     dispatcher.include_router(handlers_router)
#     await set_commands(bot)
#
#     async def _start_polling():
#         await dispatcher.start_polling(bot, handle_signals=False)
#
#     polling_task = asyncio.create_task(_start_polling())
#
#     yield
#
#     polling_task.cancel()
#     await bot.session.close()
```
или тут
```
# if __name__ == "__main__":
#     logger.info("Starting...")
#     uvicorn.run(
#         web_app,
#         host="0.0.0.0",
#         port=8000,
#         log_level="info",
#     )
#     logger.info("Stopping...")
```

#### Вообщем таких строчек много где можно найти, их все желательно убрать.

5. Надо больше валидации для надежности.

Всегда когда вижу обращение по индексам, то сразу настораживает:
```
return completion.choices[0].message.content
```

Код не запускал, и что в переменной completion не знаю, но проверить есть ли атрибут choices для начала, и есть ли в нем что-то индексируемое.
Вдруг `choices[0]` окажется пустым?

6. Нейминг

checking_session_id -> check_session_id или ensure_session_exists
Проверить айди сессии, а не проверка айди сессии

7. В классе `HuggingFacePredictor` есть параметр `token_env_var`, но он в нем не используется вообще.
Точнее используется, но только в строке, где поднимается ошибка:
```            
raise ValueError(f"API token '{token_env_var}' не найден в переменных окружения")
```
Тут, кстати, в этой ошибке слишком широкая ошибка ValueError - ее можно заменить на кастомную, например HFTokenError

В этом классе просится ещё более гибкая настройка промта, например в отдельном json файле. А в env задавать имя этого файла (или путь к нему).
Тогда получится вообще огонь - управлять свойствами ответов через настройки окружения.

8. Логи, лооооги залетели в гит, они туда не должны были попасть:
`/Bot_motivation/src/logs/app.log` и точно такой же файл залетел почему-то сюда `/Bot_motivation/src/app/db/alembic/app.log` и сюда `Bot_motivation/logs/app.log`
и даже тут есть файлик `/Bot_motivation/tests/logs/app.log`

А вообще прикольно, можно увидеть когда запускалось приложение с 6 по 22 октября, какие ошибки падали.

Вообще что есть логгер - это хорошо, очень важная часть программы.
Но вот такие вообщения лучше на уровень ниже в debug
```
self.logger.info(
    f"Вызывается класс BotManager, где keyboard ={keyboard},message.message_id={message.message_id}"
)
```
а то можно словить переполнение сервера текстами в логами, в моей практике уже бывало такое несколько раз

9. Класс `CreateUser` есть такое странное поле `uuid: str = Field(..., description="ID telegram or UUID")`
Оно либо ID telegram либо UUID, толи рыба, толи мясо, вообщем неясно что именно ожидается, лучше таких непоняток избегать, явное лучше не явного

10. Структура проекта везде хорошая, за исключением директории `docker`. Ожидается, что там будет что-то связанное с контейнеризацией всего приложения,
а там лежит ещё одна директория `nginx` и в ней уже `Dockerfile` от nginx и конфиг `nginx.conf`. Просится просто одна директория `nginx`.
И обычно nginx запускается как служба линуксовая, а не в докере, ну это на любителя. По сложности запуска одинаково. По производительности без докера будет лучше.
Если будет куча контейнеров, то лушче и nginx в контейнере.

## Общий итог

Отличная работа с профессиональным подходом!

Интересная идея проекта вообще!

Больше плюсов, чем минусов, хорошая архитектура проекта, грамотное разделение ответственности.
